{% extends "admin/change_list.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6 space-y-4 dark:bg-slate-900 dark:text-slate-100 rounded-lg">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold">Import Tool Proxy</h1>
      <p class="text-sm text-slate-600 dark:text-slate-300">Ch·ªçn file Excel, xem tr∆∞·ªõc d·ªØ li·ªáu v√† ch·∫°y tool.</p>
    </div>
  </div>

  <div class="bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-3 shadow-sm">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">T·∫£i l√™n Excel (.xlsx)</label>
    <div class="flex items-center gap-3">
      <input id="excelFile" type="file" accept=".xlsx,.xls" 
      class="block w-full text-sm text-gray-700 dark:text-gray-100 file:mr-4 
      file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm 
      file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100 dark:hover:file:bg-gray-600
      dark:file:bg-gray-700 dark:file:text-gray-100" />
      <button id="resetBtn" type="button" class="ui-btn ui-btn-error hidden">X√≥a</button>
    </div>
    <p id="fileInfo" class="text-xs text-gray-500 dark:text-gray-400">Ch∆∞a ch·ªçn file.</p>
  </div>

  <div id="previewCard" class="bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm hidden">
    <div class="flex items-center justify-between mb-3">
      <div>
        <div class="flex items-center gap-2 mb-1">
          <h2 class="text-lg font-semibold">Xem tr∆∞·ªõc d·ªØ li·ªáu</h2>
          <span id="sheetName" class="ui-badge ui-badge-primary"></span>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400">Hi·ªÉn th·ªã sheet ƒë·∫ßu ti√™n, t·ªëi ƒëa 200 d√≤ng. B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a tr·ª±c ti·∫øp trong b·∫£ng.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="addRowBtn" type="button" class="ui-btn ui-btn-success">+ Th√™m d√≤ng</button>
      </div>
    </div>
    <div class="overflow-auto max-h-[480px] border border-gray-200 dark:border-gray-700 rounded-md">
      <table class="min-w-full text-sm text-left">
        <thead id="previewHead" class="bg-gray-100 dark:bg-gray-700"></thead>
        <tbody id="previewBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
      </table>
    </div>
  </div>

  <div class="flex items-center justify-between gap-3">
    <div class="flex items-center gap-4 flex-wrap">
      <label for="maxWorkersInput" class="text-sm font-medium text-gray-700 dark:text-gray-200">S·ªë thread t·ªëi ƒëa:</label>
      <input 
        type="number" 
        id="maxWorkersInput" 
        min="1" 
        max="100" 
        value="30"
        class="w-20 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <label for="targetTotalInput" class="text-sm font-medium text-gray-700 dark:text-gray-200 whitespace-nowrap">S·ªë video t·ªëi thi·ªÉu:</label>
      <input 
        type="number" 
        id="targetTotalInput" 
        min="1" 
        value="100"
        class="w-24 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
    </div>
    <div class="flex items-center gap-3">
      <button id="gpmBtn" type="button" class="ui-btn ui-btn-primary">L·∫•y d·ªØ li·ªáu t·ª´ GPM</button>
      <button id="runBtn" type="button" disabled class="ui-btn ui-btn-success">B·∫Øt ƒë·∫ßu ch·∫°y tool</button>
    </div>
  </div>

  <!-- Jobs Status Section -->
  <div id="jobsStatusCard" class="bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm hidden">
    <div class="flex items-center justify-between mb-3">
      <div>
        <h2 class="text-lg font-semibold">Tr·∫°ng th√°i Jobs</h2>
        <p class="text-xs text-gray-500 dark:text-gray-400">Theo d√µi ti·∫øn tr√¨nh ch·∫°y tool realtime</p>
      </div>
      <div id="jobsStats" class="flex items-center gap-2 text-sm">
        <span class="ui-badge ui-badge-primary">
          <span id="statsPending">0</span> ƒêang ch·ªù
        </span>
        <span class="ui-badge ui-badge-warning">
          <span id="statsRunning">0</span> ƒêang ch·∫°y
        </span>
        <span class="ui-badge ui-badge-success">
          <span id="statsSuccess">0</span> Th√†nh c√¥ng
        </span>
        <span class="ui-badge ui-badge-error">
          <span id="statsFailed">0</span> Th·∫•t b·∫°i
        </span>
      </div>
    </div>
    <div class="overflow-auto max-h-[400px] border border-gray-200 dark:border-gray-700 rounded-md">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-100 dark:bg-gray-700">
          <tr>
            <th class="px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-100">Profile</th>
            <th class="px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-100">Keyword</th>
            <th class="px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-100">Tr·∫°ng th√°i</th>
            <th class="px-3 py-2 text-left font-semibold text-gray-700 dark:text-gray-100">L·ªói</th>
          </tr>
        </thead>
        <tbody id="jobsStatusBody" class="divide-y divide-gray-100 dark:divide-gray-700">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const fileInput = document.getElementById('excelFile');
  const fileInfo = document.getElementById('fileInfo');
  const resetBtn = document.getElementById('resetBtn');
  const runBtn = document.getElementById('runBtn');
  const previewCard = document.getElementById('previewCard');
  const previewHead = document.getElementById('previewHead');
  const previewBody = document.getElementById('previewBody');
  const sheetName = document.getElementById('sheetName');
  const gpmBtn = document.getElementById('gpmBtn');
  const addRowBtn = document.getElementById('addRowBtn');
  const jobsStatusCard = document.getElementById('jobsStatusCard');
  const jobsStatusBody = document.getElementById('jobsStatusBody');
  const maxWorkersInput = document.getElementById('maxWorkersInput');
  const targetTotalInput = document.getElementById('targetTotalInput');
  let rowsAll = [];
  let fileName = '';
  let headers = [];
  let currentSessionId = null;
  let statusPollInterval = null;

  const resetPreview = () => {
    previewHead.innerHTML = '';
    previewBody.innerHTML = '';
    previewCard.classList.add('hidden');
    resetBtn.classList.add('hidden'); // ·∫®n n√∫t X√≥a khi kh√¥ng c√≥ preview
    runBtn.disabled = true;
    runBtn.classList.add('cursor-not-allowed');
    fileInfo.textContent = 'Ch∆∞a ch·ªçn file.';
    sheetName.textContent = '';
    rowsAll = [];
    fileName = '';
    headers = [];
    
    // D·ª´ng polling v√† ·∫©n jobs status
    if (statusPollInterval) {
      clearInterval(statusPollInterval);
      statusPollInterval = null;
    }
    jobsStatusCard.classList.add('hidden');
    currentSessionId = null;
    jobsStatusBody.innerHTML = '';
  };

  resetBtn.addEventListener('click', () => {
    fileInput.value = '';
    resetPreview();
  });

  const checkEmptyRows = () => {
    if (!rowsAll || rowsAll.length === 0) {
      runBtn.disabled = true;
      runBtn.classList.add('cursor-not-allowed');
      return;
    }
    
    // Ki·ªÉm tra xem c√≥ d√≤ng n√†o tr·ªëng ho√†n to√†n kh√¥ng
    const hasEmptyRow = rowsAll.some(row => {
      if (!row) return true;
      // Ki·ªÉm tra t·∫•t c·∫£ c√°c gi√° tr·ªã trong row c√≥ r·ªóng kh√¥ng
      return Object.values(row).every(val => !val || val.toString().trim() === '');
    });
    
    if (hasEmptyRow) {
      runBtn.disabled = true;
      runBtn.classList.add('cursor-not-allowed');
    } else {
      runBtn.disabled = false;
      runBtn.classList.remove('cursor-not-allowed');
    }
  };

  const attachCellListeners = () => {
    previewBody.querySelectorAll('td[contenteditable="true"]').forEach(td => {
      // X√≥a listener c≈© n·∫øu c√≥
      const newTd = td.cloneNode(true);
      td.parentNode.replaceChild(newTd, td);
      
      newTd.addEventListener('blur', (e) => {
        const rowIdx = Number(e.target.dataset.row);
        const key = e.target.dataset.key;
        if (rowIdx >= 0 && rowIdx < rowsAll.length) {
          if (!rowsAll[rowIdx]) rowsAll[rowIdx] = {};
          rowsAll[rowIdx][key] = e.target.textContent.trim();
        }
        checkEmptyRows(); // Ki·ªÉm tra l·∫°i sau khi s·ª≠a
      });
    });
  };

  const attachDeleteListeners = () => {
    previewBody.querySelectorAll('.deleteRowBtn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const rowIdx = Number(e.target.dataset.rowIndex);
        deleteRow(rowIdx);
      });
    });
  };

  const deleteRow = (rowIdx) => {
    if (rowIdx < 0 || rowIdx >= rowsAll.length) return;
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d√≤ng n√†y?')) {
      return;
    }
    
    // X√≥a d√≤ng kh·ªèi rowsAll
    rowsAll.splice(rowIdx, 1);
    
    // Re-render table v·ªõi d·ªØ li·ªáu m·ªõi (gi·ªØ nguy√™n fileName ƒë·ªÉ bi·∫øt c√≥ ph·∫£i t·ª´ GPM kh√¥ng)
    if (rowsAll.length > 0) {
      renderTable(rowsAll);
    } else {
      // N·∫øu kh√¥ng c√≤n d·ªØ li·ªáu, reset preview
      resetPreview();
    }
  };

  const renderTable = (data) => {
    // N·∫øu data l√† slice, c·∫≠p nh·∫≠t rowsAll tr∆∞·ªõc
    // N·∫øu kh√¥ng, d√πng rowsAll tr·ª±c ti·∫øp
    if (!rowsAll || rowsAll.length === 0) {
      previewCard.classList.add('hidden');
      runBtn.disabled = true;
      headers = [];
      return;
    }

    headers = Object.keys(rowsAll[0]);
    
    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu t·ª´ file excel ho·∫∑c GPM kh√¥ng (c√≥ fileName)
    const hasData = fileName && fileName !== '';
    
    // Th√™m c·ªôt "X√≥a" v√†o header ch·ªâ khi c√≥ d·ªØ li·ªáu
    const actionHeader = hasData ? '<th class="px-3 py-2 font-semibold text-gray-700 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 w-20">Thao t√°c</th>' : '';
    previewHead.innerHTML = '<tr>' + 
      headers.map(h => `<th class="px-3 py-2 font-semibold text-gray-700 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700">${h}</th>`).join('') + 
      actionHeader +
      '</tr>';

    // Render t·ª´ rowsAll g·ªëc, ch·ªâ hi·ªÉn th·ªã 200 d√≤ng ƒë·∫ßu
    const displayRows = rowsAll.slice(0, 200);
    previewBody.innerHTML = displayRows.map((row, idx) => {
      const cells = headers.map(h => {
        const val = row[h] ?? '';
        return `<td data-row="${idx}" data-key="${h}" contenteditable="true" class="px-3 py-2 text-gray-700 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500/40 rounded-sm">${val}</td>`;
      }).join('');
      
      // Ch·ªâ hi·ªÉn th·ªã n√∫t x√≥a khi c√≥ d·ªØ li·ªáu t·ª´ file
      const deleteButton = hasData ? `<td class="px-3 py-2 text-center"><button data-row-index="${idx}" class="deleteRowBtn px-2 py-1 text-xs rounded bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-200 hover:bg-red-200 dark:hover:bg-red-900/60">X√≥a</button></td>` : '';
      return `<tr data-row-index="${idx}">${cells}${deleteButton}</tr>`;
    }).join('');

    attachCellListeners();
    if (hasData) {
      attachDeleteListeners();
    }

    previewCard.classList.remove('hidden');
    resetBtn.classList.remove('hidden'); // Hi·ªÉn th·ªã n√∫t X√≥a khi c√≥ preview
    checkEmptyRows(); // Ki·ªÉm tra d√≤ng tr·ªëng
  };

  const addNewRow = () => {
    // Ki·ªÉm tra d√≤ng cu·ªëi c√πng c√≥ tr·ªëng ho√†n to√†n kh√¥ng
    if (rowsAll.length > 0) {
      const lastRow = rowsAll[rowsAll.length - 1];
      const isLastRowEmpty = !lastRow || Object.values(lastRow).every(val => !val || val.toString().trim() === '');
      
      if (isLastRowEmpty) {
        alert('Vui l√≤ng ƒëi·ªÅn √≠t nh·∫•t m·ªôt √¥ trong d√≤ng cu·ªëi c√πng tr∆∞·ªõc khi th√™m d√≤ng m·ªõi.');
        return;
      }
    }
    
    if (!headers || headers.length === 0) {
      // N·∫øu ch∆∞a c√≥ headers, t·∫°o headers m·∫∑c ƒë·ªãnh
      headers = ['profile_id', 'name', 'keyword', 'playlist_title'];
    }
    
    const newRow = {};
    headers.forEach(h => newRow[h] = '');
    rowsAll.push(newRow);
    
    // Re-render table ƒë·ªÉ c√≥ n√∫t x√≥a
    renderTable(rowsAll);
    
    // Scroll to new row v√† focus
    const rowIdx = rowsAll.length - 1;
    const newRowEl = previewBody.querySelector(`tr[data-row-index="${rowIdx}"]`);
    if (newRowEl) {
      newRowEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      // Focus v√†o √¥ ƒë·∫ßu ti√™n c√≥ th·ªÉ edit ƒë∆∞·ª£c
      const firstEditableCell = newRowEl.querySelector('td[contenteditable="true"]');
      if (firstEditableCell) {
        setTimeout(() => firstEditableCell.focus(), 100);
      }
    }
  };

  addRowBtn.addEventListener('click', addNewRow);

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) {
      resetPreview();
      return;
    }
    fileName = file.name;
    fileInfo.textContent = `ƒê√£ ch·ªçn: ${file.name} (${Math.round(file.size / 1024)} KB)`;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.SheetNames[0];
      const sheet = workbook.Sheets[firstSheet];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: '', raw: false });
      rowsAll = json; // l∆∞u full d·ªØ li·ªáu ƒë·ªÉ g·ª≠i backend
      sheetName.textContent = `Sheet: ${firstSheet}`;
      renderTable(rowsAll);
    };
    reader.readAsArrayBuffer(file);
  });

  const updateJobsStatus = () => {
    if (!currentSessionId) return;
    
    const csrftoken = document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1] || '';
    fetch(`{% url 'youtube:get_jobs_status' %}?session_id=${currentSessionId}`, {
      headers: {
        'X-CSRFToken': csrftoken,
      },
    })
      .then(res => res.json())
      .then(data => {
        if (data?.success) {
          renderJobsStatus(data.jobs, data.stats);
          
          // N·∫øu t·∫•t c·∫£ jobs ƒë√£ ho√†n th√†nh (kh√¥ng c√≤n pending ho·∫∑c running), d·ª´ng polling
          if (data.stats.pending === 0 && data.stats.running === 0) {
            if (statusPollInterval) {
              clearInterval(statusPollInterval);
              statusPollInterval = null;
            }
            runBtn.disabled = false;
            runBtn.textContent = 'B·∫Øt ƒë·∫ßu ch·∫°y tool';
          }
        }
      })
      .catch(err => {
        console.error('L·ªói khi l·∫•y status:', err);
      });
  };

  const renderJobsStatus = (jobs, stats) => {
    // C·∫≠p nh·∫≠t stats
    document.getElementById('statsPending').textContent = stats.pending || 0;
    document.getElementById('statsRunning').textContent = stats.running || 0;
    document.getElementById('statsSuccess').textContent = stats.success || 0;
    document.getElementById('statsFailed').textContent = stats.failed || 0;
    
    // Render danh s√°ch jobs
    jobsStatusBody.innerHTML = jobs.map(job => {
      const statusClass = {
        'pending': 'ui-badge ui-badge-primary',
        'running': 'ui-badge ui-badge-warning',
        'success': 'ui-badge ui-badge-success',
        'failed': 'ui-badge ui-badge-error',
        'unknown': 'ui-badge ui-badge-secondary',
      }[job.status] || 'ui-badge ui-badge-secondary';
      
      const statusText = {
        'pending': '‚è≥ ƒêang ch·ªù',
        'running': 'üîÑ ƒêang ch·∫°y',
        'success': '‚úÖ Th√†nh c√¥ng',
        'failed': '‚ùå Th·∫•t b·∫°i',
        'unknown': '‚ùì Kh√¥ng x√°c ƒë·ªãnh',
      }[job.status] || job.status;
      
      return `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
          <td class="px-3 py-2 text-gray-700 dark:text-gray-100">${job.name || job.profile_id || '-'}</td>
          <td class="px-3 py-2 text-gray-700 dark:text-gray-100">${job.keyword || '-'}</td>
          <td class="px-3 py-2">
            <span class="px-2 py-1 rounded text-xs font-medium ${statusClass}">${statusText}</span>
          </td>
          <td class="px-3 py-2 text-xs text-red-600 dark:text-red-400">${job.error || '-'}</td>
        </tr>
      `;
    }).join('');
  };

  runBtn.addEventListener('click', () => {
    if (runBtn.disabled) return;
    const csrftoken = document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1] || '';
    runBtn.disabled = true;
    runBtn.textContent = 'ƒêang g·ª≠i...';
    
    // D·ª´ng polling c≈© n·∫øu c√≥
    if (statusPollInterval) {
      clearInterval(statusPollInterval);
      statusPollInterval = null;
    }

    fetch("{% url 'youtube:import_tool_run' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({
        filename: fileName,
        rows: rowsAll,
        max_workers: parseInt(maxWorkersInput.value) || 30,
        target_total: parseInt(targetTotalInput.value) || 100,
      }),
    }).then(res => res.json())
      .then(data => {
        if (data?.success) {
          // L∆∞u session_id v√† b·∫Øt ƒë·∫ßu tracking
          currentSessionId = data.session_id;
          jobsStatusCard.classList.remove('hidden');
          
          // Hi·ªÉn th·ªã loading ban ƒë·∫ßu
          jobsStatusBody.innerHTML = `
            <tr>
              <td colspan="4" class="px-3 py-4 text-center text-gray-500 dark:text-gray-400">
                ƒêang kh·ªüi t·∫°o jobs...
              </td>
            </tr>
          `;
          
          // B·∫Øt ƒë·∫ßu polling ƒë·ªÉ c·∫≠p nh·∫≠t status
          updateJobsStatus(); // G·ªçi ngay l·∫≠p t·ª©c
          statusPollInterval = setInterval(updateJobsStatus, 2000); // Poll m·ªói 2 gi√¢y
          
          runBtn.textContent = 'ƒêang ch·∫°y...';
        } else {
          alert(data?.error || 'C√≥ l·ªói x·∫£y ra.');
          runBtn.disabled = false;
          runBtn.textContent = 'B·∫Øt ƒë·∫ßu ch·∫°y tool';
        }
      })
      .catch(() => {
        alert('C√≥ l·ªói k·∫øt n·ªëi m√°y ch·ªß.');
        runBtn.disabled = false;
        runBtn.textContent = 'B·∫Øt ƒë·∫ßu ch·∫°y tool';
      });
  });

  // N√∫t l·∫•y d·ªØ li·ªáu t·ª´ GPM (placeholder)
  gpmBtn.addEventListener('click', () => {
    get_data_gpm();
  });

  function get_data_gpm() {
    gpmBtn.disabled = true;
    gpmBtn.textContent = 'ƒêang l·∫•y...';
    const csrftoken = document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1] || '';
    fetch("{% url 'youtube:get_data_gpm' %}", {
      headers: {
        'X-CSRFToken': csrftoken,
      },
    })
      .then(res => res.json())
      .then(resp => {
        if (!resp?.success || !Array.isArray(resp.data)) {
          alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu GPM.');
          return;
        }
        const data = resp.data.map(item => ({
          profile_id: item.id,
          name: item.name,
          keyword: '',
          playlist_title: '',
        }));
        rowsAll = data;
        fileName = 'gpm_profiles';
        sheetName.textContent = 'GPM profiles';
        renderTable(rowsAll);
        fileInfo.textContent = `ƒê√£ n·∫°p ${rowsAll.length} profile t·ª´ GPM. Vui l√≤ng nh·∫≠p keyword/playlist_title tr∆∞·ªõc khi ch·∫°y.`;
        checkEmptyRows(); // Ki·ªÉm tra d√≤ng tr·ªëng
      })
      .catch(() => alert('L·ªói k·∫øt n·ªëi GPM.'))
      .finally(() => {
        gpmBtn.disabled = false;
        gpmBtn.textContent = 'L·∫•y d·ªØ li·ªáu t·ª´ GPM';
      });
  }
</script>
{% endblock %}